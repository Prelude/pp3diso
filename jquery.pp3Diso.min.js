/**
 * pp3Diso
 * http://www.prelude-prod.fr
 *
 * @author Jean-François RENAULD
 * @version 1.6
 * Cette oeuvre est mise à disposition selon les termes de la Licence GPL v3 : http://www.gnu.org/licenses/gpl-3.0.txt
 *
 * Si vous utilisez ce plugin, vous devez mettre un lien retour vers le site : http://www.prelude-prod.fr
 *
 * Date: Sun Aug 03 11:30:00 UTC 2013
 */
(function(a){a.fn.pp3Diso=function(a7){var a7=a.extend({CSSid:"",mapId:1,map:"",mapZones:"",mapZonesColors:"",zone:"",tx:0,ty:0,ty2:0,zoom:1,positionFixe:false,pathfinding:false,PF_corners:true,cursorPF:"",cursorZindex:0,PF_decx:0,PF_decy:0,PF_max:false,mousewheel:false,zoom_min:0.25,zoom_max:10,zoom_pas:0.5,fluide:true,nbrTitleSetsSlide:1,auto_resize:true,mode2d:false,mode2d_viewx:5,mode2d_viewy:5,mode2d_select:"#FBE6C1",mode2d_select_off:"#F47070",mode2d_fond:"#ffffff",titre_map:{},titre_case:"",mode2d_avatar:"Avatar",move_avatar_speed:50,bulle_auto_x:true,bulle_auto_y:"top",bulle_obj_deca_y:6,keys:true,keys_tab:{key_n:[38,104],key_ne:[105],key_e:[39,102],key_se:[99],key_s:[40,98],key_so:[97],key_o:[37,100],key_no:[103],key_zoom:[33],key_dezoom:[34],key_clic:[32,101]},prefix:"map-",path:"images/",fogofwar:0,speed_avatar:250,speed_map:100,speed_map_while:100,speed_by_titleset:1,drag:true,cursorDelay:false,oncursordelay:function(bu,bw,bv){},onmoveavatar:function(bu,bw,bv){},beforemoveavatar:function(bu,bw,bv){return true},onmovepathfinding:function(bu,bw,bv){},beforeclosewin:function(bv,bu){return true},afterclosewin:function(bv,bu){},onenterbuilding:function(bu,bw,bv){},onleavebuilding:function(bu,bw,bv){},onenterobject:function(bu,bw,bv){},onleaveobject:function(bu,bw,bv){},onclicbuilding:function(bu,bw,bv){},onclicobject:function(bu,bw,bv){},onchangezoom:function(bu){},onclicright:""},a7);var j=a(this);var d=this;var al=("ontouchstart" in window);if(a7.positionFixe==true){a7.drag=false}a7.ty2=(a7.tx>>2);var n=1;var bb="";if(a.browser.msie&&((a.browser.version)|0)<9){bb="msie"}var e=0;var c=0;var an=0;var X=0;if(a7.mode2d){mousewheel=false}var v;var S=a7.tx;var R=a7.ty;var aw=a7.ty2;var ak="";var aG=0;var aD=0;var br=1;var bp=1;var q,bh,aF;var a3,a2;var ah=0;var ag=0;var ax=null;var A=[];var aV=[];var aa=false;var O,N;var m="";var aC="";var bd=0;var bc=0;var V=0;var T=0;var ap=false;var ai;var bn=false;var ar=false;var w;var a6=[];var bm=a7.PF_max;var ab;var aU;var bj=false;var M,bo,J,K,ad,I,E;var G,D,aL,am,aN,aM,C;var bk=[];var aq,bq,at;var af,ae,H;var aA,ay;var ao=false;var r,p;var a1=false;var a4=0;move_map_waiting=false;aO();var z;var bt=null;var L="";var av=1;function aO(){v=~~(a7.zoom*100)+"%";a7.tx=S*a7.zoom;a7.ty=R*a7.zoom;a7.ty2=aw*a7.zoom;bj=false;af=j.width();ae=j.height();if(a7.zone=="undefined"){a7.zone=""}var bB=j.children(".pp3diso_users").detach();j.children().remove().empty();j.append(bB);a(".pp3diso_users").css({"z-index":760000});if(!a7.mode2d){j.append('<div id="pp3Diso-wait"></div>');ab=a("#pp3Diso-wait")}bo=a7.map.split(":");if(a7.zone!=""){var bA=a7.zone.split(":")}M=a7.path+a7.prefix;dummy=bo[0].split(",");J=bo.length;K=dummy.length;w=new Array(K);for(bu=0;bu<J;bu++){w[bu]=new Array(J)}aL=(a7.tx>>1);am=a7.ty2;aN=(K*((a7.tx)>>1))+(J*((a7.tx)>>1));aM=(K*((a7.ty)>>1))+(J*((a7.ty)>>1));C=aN>>1;if(a7.mapZones!=""){var bw=a7.mapZones.split(":")}ad=new Array(J);I=new Array(J);E=new Array(J);z=new Array(J);aq=new Array(J);G=0;D=0;aj();for(var bz=1;bz<=J;bz++){E[bz]=new Array(K);ad[bz]=new Array(K);aq[bz]=new Array(K);I[bz]=new Array(K);z[bz]=new Array(K);var by=bo[bz-1].split(",");if(a7.zone!=""){var bx=bA[bz-1].split(",")}if(a7.mapZones!=""){var bv=bw[bz-1].split(",")}for(var bu=1;bu<=K;bu++){E[bz][bu]=~~(by[bu-1]);if(a7.fogofwar>0){I[bz][bu]=0}else{I[bz][bu]=1}f(bu,bz);if(a7.zone!=""){ad[bz][bu]=~~(bx[bu-1])}else{if(E[bz][bu]>0){ad[bz][bu]=1}else{ad[bz][bu]=0}}if(a7.mapZones!=""){aq[bz][bu]=(bv[bu-1]|0)}else{aq[bz][bu]=0}}}if(a7.auto_size){j.css({width:aN,height:aM})}e=((af-aN)>>1);c=((ae-aM)>>1);an=e;X=c;aS(E);be((K|0),(J|0));aX(E);a("#ppISO").bind("mouseenter",function(){a("#ppISO").focus()});a("#ppISO").focus()}function aS(bP){O=0;N=0;var bH="";var bK=[0,am,aL,0,a7.tx,am,aL,am<<1];var bL=(a7.zoom<<3);var bJ=(bL>>1);var bz=[-bL,am,aL,-bJ,a7.tx+bL,am,aL,(am<<1)+bJ];if(a("#pp3Diso-conteneur").length==0){j.append('<div id="pp3Diso-conteneur"></div>')}a(".pp3diso").unbind("keyup");H=a("#pp3Diso-conteneur");if(!a7.mode2d){H.css({display:"block",position:"absolute",top:9999,left:9999,width:aN,height:aM})}if(a7.mousewheel){ac()}var bF=a7.mapZonesColors.split(":");if(!a7.mode2d&&a7.mapZones!=""&&a("#pp3Diso-mapZone").length==0){H.append('<div id="pp3Diso-mapZone"></div>');var bx=bF.length;bq=new Array(bx);at=new Array(bx);var bQ=new Array(bx);for(var bM=0;bM<bx;bM++){bQ[bM]=document.createElement("canvas");bQ[bM].id="pp3Diso-mapZone-canvas-"+bM;a("#pp3Diso-mapZone").append(bQ[bM]);if(a.browser.msie&&!window.HTMLCanvasElement){bq[bM]=window.G_vmlCanvasManager.initElement(bQ[bM])}else{bq[bM]=a("#pp3Diso-mapZone-canvas-"+bM)[0]}at[bM]=bq[bM].getContext("2d");bq[bM].width=aN;bq[bM].height=aM;a("#pp3Diso-mapZone-canvas-"+bM).css({display:"none",position:"absolute",top:0,left:0,"z-index":299000,"-moz-opacity":0.5,opacity:0.5,filter:"alpha(opacity=50)"})}a("#pp3Diso-mapZone").css({display:"block",position:"absolute",top:0,left:0,width:aN,height:aM,"z-index":299000})}if(!a7.mode2d){ab.css("display","block")}if(a("#pp3Diso-bulle").length==0){H.append('<div id="pp3Diso-bulle"></div>')}aU=a("#pp3Diso-bulle");aU.css("display","none");var bO="pp3diso-Map-"+n;n++;var bA='<map name="'+bO+'" id="'+bO+'">';for(var bE=1;bE<=J;bE++){for(var bG=1;bG<=K;bG++){bH="c_"+bE+"_"+bG;var bC=bl(bE,bG);var bD=u(bE,bG);z[bE][bG]=new Array(2);z[bE][bG][0]=(bD|0);z[bE][bG][1]=(bC|0);if(a7.mapZones!=""&&!a7.mode2d){if(aq[bE][bG]>0){var bI=aq[bE][bG]-1;at[bI].fillStyle=bF[bI];at[bI].beginPath();at[bI].moveTo(~~(bz[0]+bD),~~(bz[1]+bC));var by=bK.length-1;for(var bN=2;bN<by;bN+=2){at[bI].lineTo(~~(bz[bN]+bD),~~(bz[bN+1]+bC))}at[bI].closePath();at[bI].fill()}}if(a7.mode2d){}else{var bB="";var by=bK.length;for(var bM=0;bM<by;bM+=2){var bw=~~((bK[bM])+bD);var bv=~~((bK[bM+1])+bC);bB+=","+bw+","+bv}bB=bB.substring(1);var bu="s_"+bE+"_"+bG;bB='<area id="'+bu+'" class="pp3diso-shap" shape="poly" coords="'+bB+'" alt="" />';bA+=bB}}}if(!a7.mode2d){bA+="</map>";H.prepend('<div id="pp3diso-clicks"><img src="'+a7.path+'vide.gif" id="pp3diso-mapControl" width="'+aN+'" height="'+aM+'" alt="" />'+bA+"</div>");a("#pp3diso-mapControl").attr("usemap","#"+bO);a("#pp3diso-clicks").css({"z-index":750000,position:"absolute",left:0,top:0,display:"block"})}if(a7.keys){a(window).keyup(function(bX){var bS=V;var bY=T;var bV=false;var bR=null;for(var bW in a7.keys_tab){for(var bU in a7.keys_tab[bW]){if(a7.keys_tab[bW][bU]==bX.keyCode){bR=bW;bV=true;break}}}switch(bR){case"key_n":bY--;break;case"key_ne":bY--;bS++;break;case"key_e":bS++;break;case"key_se":bY++;bS++;break;case"key_s":bY++;break;case"key_so":bY++;bS--;break;case"key_o":bS--;break;case"key_no":bY--;bS--;break;case"key_clic":if(a0(bS,bY)){B(bS,bY,true)}break;case"key_zoom":b(a7.zoom+a7.zoom_pas);break;case"key_dezoom":b(a7.zoom-a7.zoom_pas);break}if(bV){if(!a7.mode2d){var bT=a("#s_"+bY+"_"+bS);if(bT.length){a9(bT)}}else{var bT=a("#c_"+bY+"_"+bS);if(bT.length){a9(bT)}}}if(bV===true){bX.stopPropagation();bX.preventDefault();return}else{return false}})}if(!a7.mode2d){if(a7.onclicright!=""){a(".pp3diso-shap").bind("contextmenu",(function(bR){a7.onclicright(br,bp,a7.mapId)}))}a(".pp3diso-shap").bind("click",(function(bR){if(window.Touch){a9(a(this))}if(!a1){aQ(a(this))}}));if(a7.cursorDelay!==false){a(".pp3diso-shap").bind("mouseenter",function(){L=a(this).attr("id");if(av==1){bt=window.setTimeout(function(){window.clearTimeout(bt);var bR=L.split("_");a7.oncursordelay(bR[2],bR[1],a7.mapId)},a7.cursorDelay)}});a(".pp3diso-shap").bind("mouseout",function(){window.clearTimeout(bt)})}if(!al){a(".pp3diso-shap").bind("mouseenter",function(){a9(a(this))})}}if(a7.drag&&!a7.mode2d){a("#pp3Diso-conteneur").bind("touchstart",function(bS){a1=false;var bT=bS.originalEvent;var bR=H.position();r=bT.changedTouches[0].clientX-bR.left;p=bT.changedTouches[0].clientY-bR.top;a("#pp3Diso-conteneur").bind("click",function(){return false});a("#pp3Diso-conteneur").bind("touchmove",function(bU){ba(bU)});a("#pp3Diso-conteneur").bind("touchend touchcancel",function(bU){bs(bU,a(this))});if(!ar){ar=true;setTimeout(function(){ar=false},100)}});a(".pp3diso-shap").bind("mousedown",function(bT){a1=false;var bR=bT||window.event;var bS=H.position();r=bR.clientX-bS.left;p=bR.clientY-bS.top;a("#pp3Diso-conteneur").bind("click",function(){return false});a("#pp3Diso-conteneur").bind("mousemove",aE).bind("mouseup",bs);return false})}j.focus()}function aE(bx){bx.preventDefault();a1=true;var bw=bx||window.event;var bv=bw.clientX-r;var bu=bw.clientY-p;if(bu>(a7.ty<<1)){bu=a7.ty<<1}if(bv>(a7.tx)){bv=a7.tx}if(bv<-((aN-af)+(a7.tx*2))){bv=-((aN-af)+(a7.tx*2))}if(bu<-((aM-ae)+a7.ty)){bu=-((aM-ae)+a7.ty)}H.css({left:bv,top:bu});return false}function bs(bA,by){var bz=H.position();var bv=~~(-bz.left/a7.tx);var bu=~~(-bz.top/a7.ty);var bx=e;var bw=c;e=bz.left;c=bz.top;a("#pp3Diso-conteneur").unbind("mousemove",aE).unbind("mouseup",bs);if(bx!=e&&bw!=c){aX(E)}a(".pp3diso-shap").unbind("touchmove");a(".pp3diso-shap").unbind("ontouchend");if(ar){ar=false;aQ(by)}return false}function ba(bw){bw.preventDefault();a1=true;var bx=bw.originalEvent;var bv=bx.changedTouches[0].clientX-r;var bu=bx.changedTouches[0].clientY-p;if(bu>(a7.ty<<1)){bu=a7.ty<<1}if(bv>(a7.tx)){bv=a7.tx}if(bv<-((aN-af)+a7.tx)){bv=-((aN-af)+a7.tx)}if(bu<-((aM-ae)+a7.ty)){bu=-((aM-ae)+a7.ty)}H.css({left:bv,top:bu});return false}function ac(){var bv=["DOMMouseScroll","mousewheel"];if(this.addEventListener){for(var bu=bv.length;bu;){j[0].addEventListener(bv[--bu],bf,false)}}else{j[0].onmousewheel=bf}}var aY=0;function bf(bz){var bB=new Date();bz.preventDefault();bz.stopPropagation();var bx=bz||window.event,bw=[].slice.call(arguments,1),bA=0,by=true,bv=0,bu=0;bz=a.event.fix(bx);bz.type="mousewheel";if(bx.wheelDelta){bA=bx.wheelDelta/120}if(bx.detail){bA=-bx.detail/3}bu=bA;if(bx.axis!==undefined&&bx.axis===bx.HORIZONTAL_AXIS){bu=0;bv=-1*bA}if(bx.wheelDeltaY!==undefined){bu=bx.wheelDeltaY/120}if(bx.wheelDeltaX!==undefined){bv=-1*bx.wheelDeltaX/120}bw.unshift(bz,bA,bv,bu);if((bB.valueOf()-aY)>1000){if(bw[1]<0){b(a7.zoom-a7.zoom_pas)}else{b(a7.zoom+a7.zoom_pas)}aY=bB.valueOf()}return false}function t(){if(!a7.mode2d){for(var bx=1;bx<=J;bx++){for(var bu=1;bu<=K;bu++){id="c_"+bx+"_"+bu;var bv=g(bx,bu)+c;var bw=h(bx,bu)+e;if(bw>-tx&&bw<(af+tx)&&bv>-ty&&bv<(ae+ty)){H.append('<div id="'+id+'" class="pp3diso-sol"></div>');a("#"+id).css({"z-index":aT(bx,bu),position:"absolute",left:(bw|0),top:(bv|0),width:a7.tx,height:a7.ty,display:"block"})}}}}}function Q(){if(a7.mode2d){aX(E)}if(a4==0&&!a7.mode2d){if(move_map_waiting){H.css("display","none")}move_map_waiting=false;bn=true;if(a7.positionFixe==true){H.animate({left:(an|0),top:(X|0)},a7.speed_map,function(){aX(E);bn=false;H.fadeIn("100");ab.css("display","none")})}else{if(a7.fluide){H.animate({left:(e|0),top:(c|0)},a7.speed_map,function(){aX(E);bn=false;H.fadeIn("100");ab.css("display","none")})}else{H.css({left:(e|0),top:(c|0)});aX(E);bn=false;ab.css("display","none")}}}else{move_map_waiting=true}}function bg(bu,bv){if(!a7.mode2d){bu=(bu|0);bv=(bv|0);id="c_"+bv+"_"+bu;a("#"+id).fadeTo(0,I[bv][bu]);id="b_"+bv+"_"+bu;a("#"+id).fadeTo(0,1);id="o_"+bv+"_"+bu;a("#"+id).fadeTo(0,1)}}function aB(bC,bB,bw){bC=(bC|0);bB=(bB|0);bw=(bw|0);if(bB<1||bC<1||bB>J||bC>K){return}if(I[bB][bC]<bw){I[bB][bC]=bw}if(I[bB][bC]>1){I[bB][bC]=1}bg(bC,bB);var bv=a7.fogofwar;for(var bu=bC-bv;bu<=bC+bv;bu++){var by=Math.abs(bu-bC);for(var bA=bB-bv;bA<=bB+bv;bA++){var bz=Math.abs(bA-bB);if(by>bz){bz=by}if(bu!=bC||bA!=bB){if(!(bA<1||bu<1||bA>J||bu>K)){var bx=(bw/bz);if(I[bA][bu]<bx){I[bA][bu]=bx}if(I[bA][bu]>1){I[bA][bu]=1}bg(bu,bA)}}}}}function aX(bP){var bG="";var bu="";var bN=a7.tx*3;var bz=a7.ty*3;if(V<1){V=1}if(T<1){T=1}if(a7.mode2d){var bE=(V|0)-(a7.mode2d_viewx|0);var bB=(V|0)+(a7.mode2d_viewx|0);if(bE<1){bB=bB-(bE-1)}if(bB>K){bE=K-(((a7.mode2d_viewx|0)<<1))}var bC=(T|0)-(a7.mode2d_viewy|0);var bA=(T|0)+(a7.mode2d_viewy|0);if(bC<1){bA=bA-(bC-1)}if(bA>J){bC=J-(((a7.mode2d_viewy|0)<<1))}if(bE<1){bE=1}if(bB>K){bB=K}if(bC<1){bC=1}if(bA>K){bA=J}}var by=af+bN;var bw=ae+bz;for(var bJ=1;bJ<=J;bJ++){if(a7.mode2d){if(bJ>=bC&&bJ<=bA){bu=bu+'<tr><th id="y'+bJ+'" axis="axe des ordonn�es">'+bJ+"</th>"}}var bv="c_"+bJ;for(var bK=1;bK<=K;bK++){var bI=z[bJ][bK][0];var bH=z[bJ][bK][1];var bF=bI+e;var bM=bH+c;var bL=bv+"_"+bK;var bx=a("#"+bL);if(a7.mode2d){if(bK>=bE&&bK<=bB&&bJ>=bC&&bJ<=bA){bu=bu+'<td headers="x'+bK+" y"+bJ+'" id="'+bL+'"></td>'}}else{if(bF>-bN&&bF<(by)&&bM>-bz&&bM<(bw)){if(bx.length==0){bu=bu+'<div id="'+bL+'" class="pp3diso-sol"></div>'}else{if(a7.fogofwar>0){bg(bK,bJ)}if(bx[0].getAttribute("display")!="block"){bx.css("display","block")}}}else{bx.remove().empty()}}}if(a7.mode2d){if(bJ>=bC&&bJ<=bA){bu=bu+"</tr>"}}}if(a7.mode2d){totalFrag_dummy='<table id="pp3diso_table">';totalFrag_dummy=totalFrag_dummy+"<tr><td>&nbsp;</td>";for(bK=bE;bK<=bB;bK++){totalFrag_dummy=totalFrag_dummy+'<th id="x'+bK+'" axis="axe des abscisses">'+bK+"</th>"}totalFrag_dummy=totalFrag_dummy+"</tr>";bu=totalFrag_dummy+bu+"</table>";a("#pp3diso_table").remove()}H.append(bu);var bD="100%";for(var bJ=1;bJ<=J;bJ++){for(var bK=1;bK<=K;bK++){var bI=h(bJ,bK);var bH=g(bJ,bK);var bF=bI+e;var bM=bH+c;var bL="c_"+bJ+"_"+bK;var bx=a("#"+bL);if(a7.mode2d){var bO=aJ(bK,bJ,bP);bx.html(bO).click(function(){var bQ=a(this).attr("id");var bS=bQ.split("_");var bT=bS[2];var bR=bS[1];if(a0(bT,bR)){B(bT,bR,true)}a9(a(this))}).mouseover(function(){a9(a(this))})}else{if(bF>-bN&&bF<(af+bN)&&bM>-bz&&bM<(ae+bz)){if(!bx.length==0){bG=bP[bJ][bK]+".png";if(bG!="NaN.png"){bG=M+bG;if(a7.zoom!=1&&bb=="msie"){bx.css({"z-index":aT(bJ,bK),position:"absolute",left:(bI|0),top:(bH|0),width:a7.tx,height:a7.ty,"background-image":"url('"+bG+"')",display:"block","-webkit-background-size":bD+" "+bD,"-o-background-size":bD+" "+bD,"-moz-background-size":bD+" "+bD,"background-size":bD+" "+bD,"background-position":"center center","background-repeat":"no-repeat","-ms-filter":"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+bG+"', sizingMethod='scale')",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+bG+"', sizingMethod='scale')"})}else{bx.css({"z-index":aT(bJ,bK),position:"absolute",left:(bI|0),top:(bH|0),width:a7.tx,height:a7.ty,"background-image":"url('"+bG+"')",display:"block","-webkit-background-size":bD+" "+bD,"-o-background-size":bD+" "+bD,"-moz-background-size":bD+" "+bD,"background-size":bD+" "+bD})}}}}}}}}function aJ(bu,bz,by){var bx="<p>";var bw="";var bv=" ";if(a7.titre_case!=""){bw=a7.titre_case;bw=aK(bw,"[x]",bu);bw=aK(bw,"[y]",bz)}bx=""+bw+bv;bx=bx+""+a7.titre_map[by[bz][bu]]+bv;bw=aH(bu,bz);if(bw!=""){bx=bx+""+bw+bv}if(br==bu&&bp==bz){bx=bx+""+a7.mode2d_avatar+bv}bx=bx+"</p>";return bx}function aK(bw,bv,bu){SRRi=bw.indexOf(bv);SRRr="";if(SRRi==-1){return bw}SRRr+=bw.substring(0,SRRi)+bu;if(SRRi+bv.length<bw.length){SRRr+=aK(bw.substring(SRRi+bv.length,bw.length),bv,bu)}return SRRr}function aT(bv,bu){return(bu<<1)+(bv<<1)}function u(bw,bu){bu=bu|0;bw=bw|0;var bv=C+((bu-1)*aL);bv=bv-(aL*(bw+1))+aL;return(bv|0)}function bl(bw,bu){bu=bu|0;bw=bw|0;var bv=(bw-1)*(am);bv=bv+(am*(bu-1));return(bv|0)}function h(bv,bu){return z[bv|0][bu|0][0]}function g(bv,bu){return z[bv|0][bu|0][1]}function W(bu){return(bu|0)}function aI(bu,bw){for(var bv in bk){if(bk[bv]["x"]==bu&&bk[bv]["y"]==bw){return true}}return false}function aH(bu,by,bw){if(typeof(bw)=="undefined"){bw=" / "}var bx="";for(var bv in bk){if(bk[bv]["x"]==bu&&bk[bv]["y"]==by){bx=bx+bw+bk[bv]["titre"]}}bx=bx.substr(bw.length);return bx}function a9(bw){var bx=bw.attr("id");if(typeof(bx)=="undefined"){return}var bz=bx.split("_");var bv=bz[2];var bB=bz[1];if(V!=bv||T!=bB){if(ad[T][V]==2){a7.onleavebuilding(V,T,a7.mapId)}else{if(aI(V,T)){a7.onleaveobject(V,T,a7.mapId)}}}V=bv;T=bB;var bu=h(bB,bv)+(bd*a7.zoom);var bA=g(bB,bv)+(bc*a7.zoom);if(a0(bv,bB)){a("#pp3diso-cursor-img").attr("src",m);color_m2d=a7.mode2d_select}else{a("#pp3diso-cursor-img").attr("src",aC);color_m2d=a7.mode2d_select_off}if(!a7.mode2d){if(a7.cursorZindex>0){var by=300000+aT(bB|0,bv|0)+(a7.cursorZindex|0);a("#pp3diso-cursor").css({display:"block",left:bu,top:bA,"z-index":by})}else{a("#pp3diso-cursor").css({display:"block",left:bu,top:bA})}}else{a("#pp3diso_table td").css("background-color",a7.mode2d_fond);bw.css("background-color",color_m2d);bw.first("p").focus()}if(ad[bB][bv]==2){a7.onenterbuilding(bv,bB,a7.mapId)}else{if(aI(bv,bB)){a7.onenterobject(bv,bB,a7.mapId)}}}var aW=false;function az(){if(!aW){a6=null;a6=[];for(y=0;y<J;y++){for(x=0;x<J;x++){if(ad[y+1][x+1]==1){w[x][y]=1}else{w[x][y]=0}}}}}function a5(bE,bC){var bz=br;var bw=bp;var bA=bE;var bx=bC;var bD,by,bB,bv;az();if(bm!=false){bD=bz-(bm+1);by=bz+bm;bB=bw-(bm+1);bv=bw+bm;if(bD<0){bD=0}if(by>=K){by=K}if(bB<0){bB=0}if(bv>=J){bv=J}}else{bD=false;by=false;bB=false;bv=false}var bu=astar(bz-1,bw-1,bA-1,bx-1,w,a7.PF_corners,bB,bv,bD,by);if(bu!=null){aR(bu);return true}else{return false}}function a8(bJ,bI,bC){var bL=br;var bK=bp;var bH=bJ;var bG=bI;var bD,bB,bA,bz;var by,bx,bw,bv;az();if(bm!=false){by=bL-(bm+1);bx=bL+bm;bw=bK-(bm+1);bv=bK+bm;if(by<0){by=0}if(bx>=K){bx=K}if(bw<0){bw=0}if(bv>=J){bv=J}}else{by=false;bx=false;bw=false;bv=false}var bM=astar(bL-1,bK-1,bH-1,bG-1,w,a7.PF_corners,bw,bv,by,bx);if(bM!=null){var bF=bM.length;for(var bP=0;bP<bF;bP++){var bO=h(bM[bP].col+1,bM[bP].row+1);var bN=g(bM[bP].col+1,bM[bP].row+1);var bR=a7.tx>>1;var bE=a7.ty>>1;if(!a7.beforemoveavatar(bJ,bI,a7.mapId)){return}if(bP<1){bD=br;bB=bp}else{bD=bM[bP-1].row+1;bB=bM[bP-1].col+1}bA=bM[bP].row+1;bz=bM[bP].col+1;var bu=1;if(bA>bD){bu=3}else{if(bA<bD){bu=2}else{if(bz>bB){bu=1}else{if(bz<bB){bu=4}else{bu=1}}}}if(bP<1){ag=bu}else{A.push(bu)}br=bJ;bp=bI;a6.push(bM[bP].col+1+","+bM[bP].row+1);var bQ=a("#pp3diso-avatar");aV.push(300000+aT(bM[bP].col+1,bM[bP].row+1));bQ.animate({left:bO+aG,top:bN+aD},{step:function(){ax++;if(ax>a7.move_avatar_speed){Z();ax=0}},duration:a7.speed_avatar,complete:function(){var bS=bM.length-A.length;if(!!bM[bS]){a7.onmovepathfinding(bM[bS].row+1,bM[bS].col+1,a7.mapId)}if(A.length){ag=A.shift()}else{if(bC){a7.onmoveavatar(bJ,bI,a7.mapId)}}var bU=a6.pop();var bT=aV.shift();if(aV.length<=1){}bQ.css("z-index",bT)}});if(a7.fogofwar>0){aB(bJ,bI,1)}}}}function Z(){if(aa){var bu=~~((a3*(ah))*a7.zoom);var bv=~~((a2*(ag-1))*a7.zoom);a("#pp3diso-avatar-img").css({left:-bu,top:-bv});ah++;if(ah>=aF){ah=0}}}function aR(bz){a(".pp3Diso_PF").remove().empty();var by=bz.length;for(var bx=0;bx<by;bx++){var bu=h(bz[bx].col+1,bz[bx].row+1);var bB=g(bz[bx].col+1,bz[bx].row+1);var bA="pp3Diso_PF_"+bu+"-"+bB;var bw='<div id="'+bA+'" class="pp3Diso_PF"></div>';H.append(bw);var bv="100%";if(a7.zoom!=1&&bb=="msie"){a("#"+bA).css({position:"absolute",display:"block",width:a7.tx,height:a7.ty,"background-image":"url('"+a7.cursorPF+"')","-webkit-background-size":bv+" "+bv,"-o-background-size":bv+" "+bv,"-moz-background-size":bv+" "+bv,"background-size":bv+" "+bv,"background-position":"center center","background-repeat":"no-repeat","-ms-filter":"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a7.cursorPF+"', sizingMethod='scale')",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+a7.cursorPF+"', sizingMethod='scale')",left:bu+a7.PF_decx,top:bB+a7.PF_decy,"z-index":300000+bz[bx].col+1+bz[bx].row+1})}else{a("#"+bA).css({position:"absolute",display:"block",width:a7.tx,height:a7.ty,"background-image":"url('"+a7.cursorPF+"')","-webkit-background-size":bv+" "+bv,"-o-background-size":bv+" "+bv,"-moz-background-size":bv+" "+bv,"background-size":bv+" "+bv,left:bu+a7.PF_decx,top:bB+a7.PF_decy,"z-index":300000+bz[bx].col+1+bz[bx].row+1})}}}function a0(bu,bw){if(a7.pathfinding){return a5(bu,bw)}else{var bv=false;if(ak==""){bv=true}else{bu=(bu|0);bw=(bw|0);if(bu>=br-1&&bu<=br+1&&bw>=bp-1&&bw<=bp+1){bv=true}else{bv=false}}if(ad[bw][bu]==1&&bv){return true}else{return false}}}function B(bC,bB,bE){bC=(bC|0);bB=(bB|0);var bA=h(bB,bC);var bz=g(bB,bC);var bx=a7.tx>>1;var bF=a7.ty>>1;if(a7.pathfinding){a8(bC,bB,bE)}else{if(!a7.beforemoveavatar(bC,bB,a7.mapId)){return}if(!a7.mode2d){var by=a("#pp3diso-avatar");by.animate({left:bA+aG,top:bz+aD},a7.speed_avatar);by.css({"z-index":300000+aT(bB,bC)})}br=bC;bp=bB;if(a7.fogofwar>0){aB(bC,bB,1)}if(bE){a7.onmoveavatar(bC,bB,a7.mapId)}}modif_move=false;if(af<aN+(a7.tx>>1)){var bw=a7.nbrTitleSetsSlide*a7.tx;var bu=~~(bA+e+bx);var bv=((af>>1)+bw);if(bu>bv){while(bu>bv){e-=bw;bu=~~(bA+e+bx)}modif_move=true}bv=((af>>1)-bw);if(bu<bv){while(bu<bv){e+=bw;bu=~~(bA+e+bx)}modif_move=true}}if(ae<aM+(a7.ty>>1)){var bw=a7.nbrTitleSetsSlide*a7.ty;var bu=~~(bz+c+bF);var bv=((ae>>1)+bw);if(bu>bv){while(bu>bv){c-=bw;bu=~~(bz+c+bF)}modif_move=true}bv=((ae>>1)-bw);if(bu<bv){while(bu<bv){c+=bw;bu=~~(bz+c+bF)}modif_move=true}}V=br;T=bp;if(!a7.mode2d){var bD=a("#s_"+T+"_"+V);if(bD.length){a9(bD)}}else{var bD=a("#c_"+T+"_"+V);a9(bD);modif_move=true}if(modif_move){Q()}}function aQ(bv){var bw=bv.attr("id");var bx=bw.split("_");var bu=bx[2];var by=bx[1];aU.css("display","none");if(ad[by][bu]==2){a7.onclicbuilding(bu,by,a7.mapId)}else{if(aI(bu,by)){a7.onclicobject(bu,by,a7.mapId)}}if(a0(bu,by)){B(bu,by,true)}}function F(bu){bu=bu.substring(0,bu.length-2);return(bu|0)}function aj(){a("#pp3diso-avatar").remove().empty()}this.reload=function(bw,bu,bx,bv){bk=null;bk=[];aP();br=1;bp=1;V=1;T=1;a7.map=bw;a7.zone=bu;a7.mapZones=bx;a7.mapId=bv;aO();Q()};this.show=function(bu){if(!a7.fogofwar>0){}B(br,bp,bu);H.css("display","none")};this.changeCursor=function(bv,bw,bu,bx){a("#pp3diso-cursor").remove().empty();O=0;l(bv,bw,bu,bx)};this.cursor=function(bv,bw,bu,bx){l(bv,bw,bu,bx)};function l(bv,bw,bu,bx){m=bv;aC=bw;bd=bu;bc=bx;if(!a7.mode2d){H.append('<div id="pp3diso-cursor"><img id="pp3diso-cursor-img" src="'+bv+'" alt="" /></div>');a("#pp3diso-cursor-img").load(function(){if(this.width<1){}else{if(O<1){a("#pp3diso-cursor-img").attr("rel",this.width+":"+this.height);O=~~(this.width*a7.zoom);N=~~(this.height*a7.zoom);this.width=O;this.height=N}}});a("#pp3diso-cursor").css({"z-index":299000,position:"absolute",left:0,top:0,display:"block"})}}function be(bu,bx){var bw=h(bx,bu);var bv=g(bx,bu);e=-((bw-(af>>1))|0);c=-((bv-(ae>>1))|0);V=bu;T=bx;br=bu;bp=bx;if(bn){setTimeout(function(){be(bu,bx)},250)}else{Q();H.css("display","block")}}this.moveTo=function(bu,bv){be(bu,bv)};this.getMonde=function(){var bu=new Array(K+1);for(x=1;x<=K;x++){bu[x]=new Array(J+1);for(y=1;y<=J;y++){bu[x][y]=E[y][x]}}return bu};this.getObjects=function(){return bk};this.getBuilding=function(){var bu=new Array(K+1);for(x=1;x<=K;x++){bu[x]=new Array(J+1);for(y=1;y<=J;y++){bv="";var bw="b_"+y+"_"+x;if(a("#"+bw+" img").length>0){var bv=a("#"+bw+" img").attr("src")}bu[x][y]=bv}}return bu};this.moveObject=function(bu,bC,bA,bv,by){for(var bx in bk){if(bk[bx]["id"]==bu){bk[bx]["x"]=bC;bk[bx]["y"]=bA;var bD=h(bA,bC)+(bk[bx]["decx"]*a7.zoom);var bB=g(bA,bC)+(bk[bx]["decy"]*a7.zoom);var bw="o_"+bu;if(bv){var bz=300000+aT(bA,bC);a("#"+bw).css("z-index",bz).animate({left:(bD|0),top:(bB|0)},by)}else{a("#"+bw).css({"z-index":300000+aT(bA,bC),left:(bD|0),top:(bB|0)})}break}}};this.killAvatar=function(){aj()};this.avatar=function(bv,bA,bx,bu,bz,bw,by){au(bv,bA,bx,bu,bz,bw,by)};function au(bC,bB,bu,bw,bv,bx,bA){if(bn){setTimeout(function(){au(bC,bB,bu,bw,bv,bx,bA)},250);return}aj();if(typeof(bx)=="undefined"){bx=false;bA=1;var by=1}else{var by=4}var bz=~~(100*bA)+"%";aG=bw*a7.zoom;aD=bv*a7.zoom;q=bw;bh=bv;br=bC;bp=bB;aF=bA;aa=bx;ak=bu;if(!a7.mode2d){H.append('<div id="pp3diso-avatar"><img id="pp3diso-avatar-img" src="'+bu+'" alt="" /></div>');a("#pp3diso-avatar-img").load(function(){var bE=this.width;var bD=this.height;a3=~~(bE/bA);a2=~~(bD/by);var bG=~~(a3*a7.zoom);var bF=~~(a2*a7.zoom);var bH=a("#pp3diso-avatar-img");a("#pp3diso-avatar").css({"z-index":300000+aT(bB,bC),position:"absolute",left:h(bB,bC)+bw,top:g(bB,bC)+bv,width:bG,height:bF,overflow:"hidden",display:"block"});bH.css({position:"absolute",display:"block",left:0,top:0,width:bG*bA,height:bF*by});B(br,bp,false)})}else{B(br,bp,false)}}this.moveAvatarTo=function(bu,bv){br=bu;bp=bv;B(bu,bv,false)};this.changeOneMap=function(bu,bA,bx){var bz="c_"+bA+"_"+bu;var bw=a("#"+bz);var bv="100%";var by=M+bx+".png";E[bA][bu]=bx;if(a7.zoom!=1&&bb=="msie"){bw.css({"background-image":"url('"+by+"')","-webkit-background-size":bv+" "+bv,"-o-background-size":bv+" "+bv,"-moz-background-size":bv+" "+bv,"background-size":bv+" "+bv,"background-position":"center center","background-repeat":"no-repeat","-ms-filter":"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+by+"', sizingMethod='scale')",filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+by+"', sizingMethod='scale')"})}else{bw.css({"background-image":"url('"+by+"')","-webkit-background-size":bv+" "+bv,"-o-background-size":bv+" "+bv,"-moz-background-size":bv+" "+bv,"background-size":bv+" "+bv})}};this.changeState=function(bu,bw,bv){ad[bw][bu]=bv};this.getState=function(bu,bv){return ad[bv][bu]};this.getOneMap=function(bu,bv){return E[bv][bu]};this.killBuilding=function(bu,bv){f(bu,bv)};function f(bu,bw){var bv="#b_"+bw+"_"+bu;ad[bw][bu]=1;if(a(bv).length){a(bv).remove().empty()}}this.addBuilding=function(bv,by,bw,bu,bx){aZ(bv,by,bw,bu,bx)};function aZ(bB,bz,bD,bw,bv){var by=v;var bC=h(bz,bB)+(bw*a7.zoom);var bA=g(bz,bB)+(bv*a7.zoom);ad[bz][bB]=2;var bu="b_"+bz+"_"+bB;H.append('<div id="'+bu+'" class="pp3diso-batiment"><img src="'+bD+'" alt="" /></div>');var bx=a("#"+bu);bx.attr("rel",bD+":"+bw+":"+bv);a4++;a("#"+bu+" img").load(function(){var bF=~~(this.width*a7.zoom);var bE=~~(this.height*a7.zoom);a(this).attr("rel",this.width+":"+this.height+":"+this.top+":"+this.left);a(this).width(bF).height(bE);a4--;if(move_map_waiting){Q()}});bx.css({"z-index":300000+aT(bz,bB),position:"absolute",left:(bC|0),top:(bA|0),display:"block"})}function s(){var bv=[];for(var bu in bk){if(bk[bu]["id"]!=""){bv[bu]=[];bv[bu]=bk[bu]}}bk=null;bk=bv}this.killObject=function(bu){U(bu)};function U(bw){var bv="#o_"+bw;for(var bu in bk){if(bk[bu]["id"]==bw){bk[bu]["id"]="";break}}s();if(a(bv).length>0){a(bv).remove()}}this.addObject=function(bv,bB,bw,bu,bA,bz,bx,by){return Y(bv,bB,bw,bu,bA,bz,bx,by)};function Y(bE,bC,bG,bx,bv,bB,bz,bu){var bF=h(bC,bE)+(bx*a7.zoom);var bD=g(bC,bE)+(bv*a7.zoom);if(typeof(bz)=="undefined"){bz=""}dummy=bk.length+1;if(typeof(bu)=="undefined"){bu=dummy}var by=[];by.id=bu;by.x=bE;by.y=bC;by.sprite=bG;by.decx=bx;by.decy=bv;by.titre=bB;by.bulle=bz;bk.push(by);if(a7.mode2d){var bu="c_"+bC+"_"+bE;var bH=a("#"+bu);if(bB!=""){bH.append("<p>"+bB+" ("+bz+")</p>")}}else{var bw="o_"+bu;a("#"+bw).remove().empty();var bA="";if(bz!=""){bA='<div class="pp3diso-obj-bulle">'+bz+"<div>"}H.append('<div id="'+bw+'" class="pp3diso-objet"><img src="'+bG+'" alt="" />'+bA+"</div>");a("#"+bw).attr("rel",bG+":"+bx+":"+bv);a4++;a("#"+bw+" img").load(function(){var bO=~~(this.width*a7.zoom);var bN=~~(this.height*a7.zoom);a(this).width(bO).height(bN);if(bz!=""){var bI=a("#"+bw+" .pp3diso-obj-bulle");if(a7.bulle_auto_x){var bJ=bI.outerWidth();var bM=~~(((bO-bJ)>>1));bI.css({left:bM})}if(a7.bulle_auto_y=="top"){var bK=bI.height();var bL=-(bK+a7.bulle_obj_deca_y);bI.css({top:bL})}else{if(a7.bulle_auto_y=="bottom"){var bK=bI.height();var bL=-(bK+a7.bulle_obj_deca_y);bI.css({bottom:bL})}}}a4--;if(move_map_waiting){Q()}});a("#"+bw).css({"z-index":300000+aT(bC,bE),position:"absolute",left:~~(bF),top:~~(bD),display:"block"})}}this.changeBulle=function(bu,bv){return P(bu,bv)};function P(bv,bw){for(var bu in bk){if(bk[bu]["id"]==bv){bk[bu]["bulle"]=bw;var bx=a("#o_"+bv+" .pp3diso-obj-bulle");bx.html(bw);break}}}function bi(){a("#pp3diso-win-fond").fadeTo(500,0,function(){a("#pp3diso-win-fond").remove().empty()});a("#pp3diso-win").remove().empty();a("#pp3diso-clicks").css("display","block")}this.message=function(bw,bF,bC){if(a("#pp3diso-win").length!=0){return}aU.css("display","none");var bB='<div id="pp3diso-win-fond"></div>';bB+='<div id="pp3diso-win"><div id="pp3diso-close"></div><div class="pp3diso-win-texte">'+bF+"</div>";if(bC!=""){var bE=bC.split("||");bB+='<div id="pp3diso-win-form">';var by=bE.length;for(var bA=0;bA<by;bA++){bz=bE[bA].split("::");bB+='<a href="#" rel="'+bz[1]+'" class="pp3diso-win-button" id="pp3diso-win-'+bA+'">'+bz[0]+"</a>"}bB+="</div>"}bB+="</div>";j.append(bB);a("#pp3diso-win-0").focus();var bD=a("#pp3diso-win");bz=(af/3);var bv=(bz<<1);var bx=(bz>>1);var bu=-1;a("#pp3diso-win-fond").css({position:"absolute",width:aN,height:aM,left:0,top:0,"z-index":800000,display:"block"}).fadeTo(0,0.4);bD.css({position:"absolute",width:bv,left:bx,top:50,"z-index":800001,display:"none"});bD.slideDown(100);a("#pp3diso-clicks").css("display","none");a("#pp3diso-close").click(function(bG){bG.preventDefault();bG.stopImmediatePropagation();a7.beforeclosewin(0);bD.slideUp("fast",function(){bi();a7.afterclosewin(bw,bu)})});if(bC!=""){var bE=bC.split("||");var by=bE.length;for(var bA=0;bA<by;bA++){var bz=bE[bA].split("::");a("#pp3diso-win-"+bA).click(function(bH){bH.preventDefault();bH.stopImmediatePropagation();var bG=a(this).attr("rel");a7.beforeclosewin(bG);bD.slideUp("fast",function(){bi();a7.afterclosewin(bw,bG)})})}}};this.zoomMap=function(bu){b(bu)};function aP(){a("#pp3diso-clicks").remove().empty();a("#pp3diso-Map").remove().empty();if(a7.mapZonesColors!=""){var bu=a7.mapZonesColors.split(":");var bv=bu.length;for(i=0;i<bv;i++){at[i].clearRect(0,0,bq[i].width,bq[i].height)}a("pp3Diso-mapZone").remove().empty()}}function b(bv){a("#pp3diso-avatar").clearQueue();A=null;A=[];aV=null;aV=[];a(".pp3Diso_PF").remove().empty();if(bv<a7.zoom_min){bv=a7.zoom_min}if(bv>a7.zoom_max){bv=a7.zoom_max}aP();var by=a7.zoom;a7.zoom=bv;var bD=by-bv;var bG=e-((e*bD)|0);var bL=c-((c*bD)|0);e=bG;c=bL;v=~~(a7.zoom*100)+"%";a7.tx=S*a7.zoom;a7.ty2=(a7.tx>>1);a7.ty=R*a7.zoom;a7.ty2=aw*a7.zoom;aL=(a7.tx>>1);am=a7.ty2;aN=~~((K*((a7.tx)>>1))+(J*((a7.tx)>>1)));aM=~~((K*((a7.ty)>>1))+(J*((a7.ty)>>1)));C=(aN>>1);an=((af-aN)>>1);X=((ae-aM)>>1);if(a7.mapZonesColors!=""){var bB=a7.mapZonesColors.split(":");var bx=bB.length;for(bJ=0;bJ<bx;bJ++){bq[bJ].width=aN;bq[bJ].height=aM}}if(a7.auto_size){j.css({width:aN,height:aM})}aS(E);if(!a7.mode2d){ab.css("display","block")}aX(E);var bK=[];bK=bk;bk=null;bk=[];for(var bJ in bK){if(bK[bJ]["id"]!=""){var bE="o_"+bK[bJ]["id"];a("#"+bE).remove().empty();Y(bK[bJ]["x"],bK[bJ]["y"],bK[bJ]["sprite"],bK[bJ]["decx"],bK[bJ]["decy"],bK[bJ]["titre"],bK[bJ]["bulle"],bK[bJ]["id"])}}for(var bA=1;bA<=J;bA++){for(var bC=1;bC<=K;bC++){if(ad[bA][bC]==2){var bE="b_"+bA+"_"+bC;bK=(a("#"+bE).attr("rel")).split(":");a("#"+bE).remove().empty();aZ(bC,bA,bK[0],bK[1],bK[2])}}}var bu=a("#pp3diso-cursor-img");if(!bu.length==0){var bK=bu.attr("rel").split(":");O=~~(bK[0]*a7.zoom);N=~~(bK[1]*a7.zoom);bu.attr("width",O).attr("height",N)}var bI=a("#pp3diso-avatar-img");if(!(bI.length==0)){if(aa){nbr_x=4}else{nbr_x=1}var bw=~~(100*aF)+"%";var bH=~~((a3*aF*a7.zoom)/aF);var bF=~~((a2*a7.zoom));var bz=a("#pp3diso-avatar-img");a("#pp3diso-avatar").css({width:bH,height:bF});bz.css({position:"absolute",overflow:"hidden",display:"block",left:0,top:0,width:bH*aF,height:bF*nbr_x})}aG=q*a7.zoom;aD=bh*a7.zoom;var bK=a7.speed_avatar;a7.speed_avatar=1;B(br,bp);a7.speed_avatar=bK;Q();a7.onchangezoom(bv)}this.moveMapOn=function(){var bw=["s","n","e","o","se","so","ne","no"];var bv=bw.length;for(var bu=0;bu<bv;bu++){var bx="#pp3diso-fleche-"+bw[bu];if(a(bx).length){a(bx).bind("mouseover",function(){var by=a(this).attr("id");by=by.substr(15);if(!ap){ap=true;k(by,a7.speed_by_titleset)}});a(bx).bind("mouseout",function(){o()})}}};function k(bw,bx){if(bn){return}var bu=(a7.ty>>1)*bx;var bv=(a7.tx>>1)*bx;switch(bw){case"n":c+=bu;break;case"ne":c-=bu;e-=bv;break;case"e":e-=bv;break;case"se":e-=bv;c+=bu;break;case"s":c-=bu;break;case"so":c+=bu;e+=bv;break;case"o":e+=bv;break;case"no":c-=bu;e+=bv;break}if(e<-(aN-af)){e=-(aN-af)}if(e>0){e=0}if(c<-(aM-ae)){c=-(aM-ae)}if(c>0){c=0}Q();if(ap){clearInterval(ai);ai=setInterval(function(){if(ap&&!bn){k(bw,bx)}},a7.speed_map_while)}}this.moveMapOne=function(bu,bv){k(bu,bv)};this.moveMapWhile=function(bu,bv){ap=true;k(bu,bv)};function o(){ap=false;clearInterval(ai)}this.moveMapStop=function(){o()};this.tipShow=function(bx,bv,bu,bw){aU.css({display:"none"});aU.html(bx);if(bv==0){bu=h(T,V)+bd+bu;bw=g(T,V)+bc+bw}else{if(bv==1){if(bu<0){bu+=af;bu-=aU.outerWidth()}if(bw<0){bw+=ae;bw-=aU.outerHeight()}bu-=e;bw-=c}}aU.css({top:bw,left:bu,display:"none"});aU.stop(true,true).fadeIn("normal");bj=true};this.tipHide=function(){aU.stop(true,true).fadeOut("normal",function(){bj=false})};this.toggleZone=function(bv,bw){if(bw==""){bw="normal"}bv--;var bu=a("#pp3Diso-mapZone-canvas-"+bv);if(bu.css("display")=="none"){bu.fadeIn(bw)}else{bu.fadeOut(bw)}};this.showZone=function(bu,bv){if(bv==""){bv="normal"}bu--;a("#pp3Diso-mapZone-canvas-"+bu).fadeIn(bv)};this.hideZone=function(bu,bv){if(bv==""){bv="normal"}bu--;a("#pp3Diso-mapZone-canvas-"+bu).fadeOut(bv)};this.switchCursorDelay=function(bu){av=bu};return this}})(jQuery);var mapLength,mapRowLength,gMinx,gMaxx,gMiny,gMaxy;function astar(j,f,k,g,b,d,r,o,q,m){var h=[];var l=[];var a=[];if(o==false){gMaxx=b.length}else{gMaxx=o}if(r==false){gMinx=0}else{gMinx=r}if(m==false){gMaxy=b[0].length}else{gMaxy=m}if(q==false){gMiny=0}else{gMiny=q}mapLength=gMaxx;mapRowLength=gMaxy;var e=new Node(k,g,b,null,null);var p=new Node(j,f,b,null,e);addNodeToList(p,h);var c;while(!isListEmpty(h)){c=returnNodeWithLowestFScore(h);addNodeToList(c,l);removeNodeFromList(c,h);if(areNodesEqual(c,e)){pathTo(c,a);a.reverse();return a}c.makeChildNodes(b,d,e);cullUnwantedNodes(c.childNodes,h);cullUnwantedNodes(c.childNodes,l);removeMatchingNodes(c.childNodes,h);removeMatchingNodes(c.childNodes,l);addListToList(c.childNodes,h)}return null}function pathTo(b,a){a.push(new NodeCoordinate(b.row,b.col));if(b.parentNode==null){return}pathTo(b.parentNode,a)}function addListToList(b,a){for(x in b){a.push(b[x])}}function removeMatchingNodes(d,f){var c=d.length;var e=f.length;for(var b=0;b<c;b++){for(var a=0;a<e;a++){if(f[a].row==d[b].row&&f[a].col==d[b].col){f.splice(a,1);e=f.length}}}}function cullUnwantedNodes(d,a){var e=a.length;var f=d.length;for(var c=0;c<e;c++){for(var b=0;b<f;b++){if(d[b].row==a[c].row&&d[b].col==a[c].col){if(d[b].f>=a[c].f){d.splice(b,1);f=d.length}}}}}function areNodesEqual(b,a){if(b.row==a.row&&b.col==a.col){return true}else{return false}}function returnNodeWithLowestFScore(b){var a=b[0];for(x in b){if(b[x].f<a.f){a=b[x]}}return a}function isListEmpty(a){return(a.length<1)?true:false}function removeNodeFromList(b,c){var d=c.length;for(var a=0;a<d;a++){if(b.row==c[a].row&&b.col==c[a].col){c.splice(a,1);break}}}function addNodeToList(a,b){b.push(a)}function returnHScore(b,d){var c=b.row-d.row;if(c<0){c=-c}var a=b.col-d.col;if(a<0){a=-a}if(a>c){return(c*14)+10*(a-c)}else{return(a*14)+10*(c-a)}}function NodeCoordinate(b,a){this.row=b;this.col=a}function Node(d,b,c,a,e){this.row=d;this.col=b;if(d<=gMiny){this.northAmbit=gMiny}else{this.northAmbit=d-1}if(d>=gMaxy-1){this.southAmbit=gMaxy-1}else{this.southAmbit=d+1}if(b<=gMinx){this.westAmbit=gMinx}else{this.westAmbit=b-1}if(b>=gMaxx-1){this.eastAmbit=gMaxx-1}else{this.eastAmbit=b+1}this.parentNode=a;this.childNodes=[];if(a!=null){if(d==a.row||b==a.col){this.g=a.g+10}else{this.g=a.g+14}this.h=returnHScore(this,e)}else{this.g=0;if(c[d][b]=="s"){this.h=returnHScore(this,e)}else{this.h=0}}this.f=this.g+this.h;this.makeChildNodes=function(k,f,l){for(var h=this.northAmbit;h<=this.southAmbit;h++){for(var g=this.westAmbit;g<=this.eastAmbit;g++){if(h!=this.row||g!=this.col){if(k[h][g]!="0"){if(f){this.childNodes.push(new Node(h,g,k,this,l))}else{if(h==this.row||g==this.col){this.childNodes.push(new Node(h,g,k,this,l))}}}}}}}}if(!document.createElement("canvas").getContext){(function(){var v=Math;var w=v.round;var s=v.sin;var G=v.cos;var n=v.abs;var F=v.sqrt;var a=10;var o=a/2;function h(){return this.context_||(this.context_=new q(this))}var u=Array.prototype.slice;function H(m,I,J){var j=u.call(arguments,2);return function(){return m.apply(I,j.concat(u.call(arguments)))}}var k={init:function(j){if(/MSIE/.test(navigator.userAgent)&&!window.opera){var m=j||document;m.createElement("canvas");m.attachEvent("onreadystatechange",H(this.init_,this,m))}},init_:function(J){if(!J.namespaces.g_vml_){J.namespaces.add("g_vml_","urn:schemas-microsoft-com:vml","#default#VML")}if(!J.namespaces.g_o_){J.namespaces.add("g_o_","urn:schemas-microsoft-com:office:office","#default#VML")}if(!J.styleSheets.ex_canvas_){var I=J.createStyleSheet();I.owningElement.id="ex_canvas_";I.cssText="canvas{display:inline-block;overflow:hidden;text-align:left;width:300px;height:150px}g_vml_\\:*{behavior:url(#default#VML)}g_o_\\:*{behavior:url(#default#VML)}"}var m=J.getElementsByTagName("canvas");for(var j=0;j<m.length;j++){this.initElement(m[j])}},initElement:function(m){if(!m.getContext){m.getContext=h;m.innerHTML="";m.attachEvent("onpropertychange",E);m.attachEvent("onresize",b);var j=m.attributes;if(j.width&&j.width.specified){m.style.width=j.width.nodeValue+"px"}else{m.width=m.clientWidth}if(j.height&&j.height.specified){m.style.height=j.height.nodeValue+"px"}else{m.height=m.clientHeight}}return m}};function E(m){var j=m.srcElement;switch(m.propertyName){case"width":j.style.width=j.attributes.width.nodeValue+"px";j.getContext().clearRect();break;case"height":j.style.height=j.attributes.height.nodeValue+"px";j.getContext().clearRect();break}}function b(m){var j=m.srcElement;if(j.firstChild){j.firstChild.style.width=j.clientWidth+"px";j.firstChild.style.height=j.clientHeight+"px"}}k.init();var e=[];for(var B=0;B<16;B++){for(var A=0;A<16;A++){e[B*16+A]=B.toString(16)+A.toString(16)}}function r(){return[[1,0,0],[0,1,0],[0,0,1]]}function d(J,I){var m=r();for(var j=0;j<3;j++){for(var M=0;M<3;M++){var K=0;for(var L=0;L<3;L++){K+=J[j][L]*I[L][M]}m[j][M]=K}}return m}function z(m,j){j.fillStyle=m.fillStyle;j.lineCap=m.lineCap;j.lineJoin=m.lineJoin;j.lineWidth=m.lineWidth;j.miterLimit=m.miterLimit;j.shadowBlur=m.shadowBlur;j.shadowColor=m.shadowColor;j.shadowOffsetX=m.shadowOffsetX;j.shadowOffsetY=m.shadowOffsetY;j.strokeStyle=m.strokeStyle;j.globalAlpha=m.globalAlpha;j.arcScaleX_=m.arcScaleX_;j.arcScaleY_=m.arcScaleY_;j.lineScale_=m.lineScale_}function c(m){var K,J=1;m=String(m);if(m.substring(0,3)=="rgb"){var M=m.indexOf("(",3);var j=m.indexOf(")",M+1);var L=m.substring(M+1,j).split(",");K="#";for(var I=0;I<3;I++){K+=e[Number(L[I])]}if(L.length==4&&m.substr(3,1)=="a"){J=L[3]}}else{K=m}return{color:K,alpha:J}}function t(j){switch(j){case"butt":return"flat";case"round":return"round";case"square":default:return"square"}}function q(m){this.m_=r();this.mStack_=[];this.aStack_=[];this.currentPath_=[];this.strokeStyle="#000";this.fillStyle="#000";this.lineWidth=1;this.lineJoin="miter";this.lineCap="butt";this.miterLimit=a*1;this.globalAlpha=1;this.canvas=m;var j=m.ownerDocument.createElement("div");j.style.width=m.clientWidth+"px";j.style.height=m.clientHeight+"px";j.style.overflow="hidden";j.style.position="absolute";m.appendChild(j);this.element_=j;this.arcScaleX_=1;this.arcScaleY_=1;this.lineScale_=1}var l=q.prototype;l.clearRect=function(){this.element_.innerHTML=""};l.beginPath=function(){this.currentPath_=[]};l.moveTo=function(m,j){var I=this.getCoords_(m,j);this.currentPath_.push({type:"moveTo",x:I.x,y:I.y});this.currentX_=I.x;this.currentY_=I.y};l.lineTo=function(m,j){var I=this.getCoords_(m,j);this.currentPath_.push({type:"lineTo",x:I.x,y:I.y});this.currentX_=I.x;this.currentY_=I.y};l.bezierCurveTo=function(I,m,O,N,M,K){var j=this.getCoords_(M,K);var L=this.getCoords_(I,m);var J=this.getCoords_(O,N);p(this,L,J,j)};function p(j,J,I,m){j.currentPath_.push({type:"bezierCurveTo",cp1x:J.x,cp1y:J.y,cp2x:I.x,cp2y:I.y,x:m.x,y:m.y});j.currentX_=m.x;j.currentY_=m.y}l.quadraticCurveTo=function(M,I,m,j){var L=this.getCoords_(M,I);var K=this.getCoords_(m,j);var N={x:this.currentX_+2/3*(L.x-this.currentX_),y:this.currentY_+2/3*(L.y-this.currentY_)};var J={x:N.x+(K.x-this.currentX_)/3,y:N.y+(K.y-this.currentY_)/3};p(this,N,J,K)};l.arc=function(P,N,O,K,m,I){O*=a;var T=I?"at":"wa";var Q=P+G(K)*O-o;var S=N+s(K)*O-o;var j=P+G(m)*O-o;var R=N+s(m)*O-o;if(Q==j&&!I){Q+=0.125}var J=this.getCoords_(P,N);var M=this.getCoords_(Q,S);var L=this.getCoords_(j,R);this.currentPath_.push({type:T,x:J.x,y:J.y,radius:O,xStart:M.x,yStart:M.y,xEnd:L.x,yEnd:L.y})};l.rect=function(I,m,j,J){this.moveTo(I,m);this.lineTo(I+j,m);this.lineTo(I+j,m+J);this.lineTo(I,m+J);this.closePath()};l.strokeRect=function(I,m,j,J){var K=this.currentPath_;this.beginPath();this.moveTo(I,m);this.lineTo(I+j,m);this.lineTo(I+j,m+J);this.lineTo(I,m+J);this.closePath();this.stroke();this.currentPath_=K};l.fillRect=function(I,m,j,J){var K=this.currentPath_;this.beginPath();this.moveTo(I,m);this.lineTo(I+j,m);this.lineTo(I+j,m+J);this.lineTo(I,m+J);this.closePath();this.fill();this.currentPath_=K};l.createLinearGradient=function(m,J,j,I){var K=new C("gradient");K.x0_=m;K.y0_=J;K.x1_=j;K.y1_=I;return K};l.createRadialGradient=function(J,L,I,m,K,j){var M=new C("gradientradial");M.x0_=J;M.y0_=L;M.r0_=I;M.x1_=m;M.y1_=K;M.r1_=j;return M};l.drawImage=function(V,I){var O,M,Q,ad,T,R,Y,af;var P=V.runtimeStyle.width;var U=V.runtimeStyle.height;V.runtimeStyle.width="auto";V.runtimeStyle.height="auto";var N=V.width;var ab=V.height;V.runtimeStyle.width=P;V.runtimeStyle.height=U;if(arguments.length==3){O=arguments[1];M=arguments[2];T=R=0;Y=Q=N;af=ad=ab}else{if(arguments.length==5){O=arguments[1];M=arguments[2];Q=arguments[3];ad=arguments[4];T=R=0;Y=N;af=ab}else{if(arguments.length==9){T=arguments[1];R=arguments[2];Y=arguments[3];af=arguments[4];O=arguments[5];M=arguments[6];Q=arguments[7];ad=arguments[8]}else{throw Error("Invalid number of arguments")}}}var ae=this.getCoords_(O,M);var J=Y/2;var m=af/2;var ac=[];var j=10;var L=10;ac.push(" <g_vml_:group",' coordsize="',a*j,",",a*L,'"',' coordorigin="0,0"',' style="width:',j,"px;height:",L,"px;position:absolute;");if(this.m_[0][0]!=1||this.m_[0][1]){var K=[];K.push("M11=",this.m_[0][0],",","M12=",this.m_[1][0],",","M21=",this.m_[0][1],",","M22=",this.m_[1][1],",","Dx=",w(ae.x/a),",","Dy=",w(ae.y/a),"");var aa=ae;var Z=this.getCoords_(O+Q,M);var X=this.getCoords_(O,M+ad);var S=this.getCoords_(O+Q,M+ad);aa.x=v.max(aa.x,Z.x,X.x,S.x);aa.y=v.max(aa.y,Z.y,X.y,S.y);ac.push("padding:0 ",w(aa.x/a),"px ",w(aa.y/a),"px 0;filter:progid:DXImageTransform.Microsoft.Matrix(",K.join(""),", sizingmethod='clip');")}else{ac.push("top:",w(ae.y/a),"px;left:",w(ae.x/a),"px;")}ac.push(' ">','<g_vml_:image src="',V.src,'"',' style="width:',a*Q,"px;"," height:",a*ad,'px;"',' cropleft="',T/N,'"',' croptop="',R/ab,'"',' cropright="',(N-T-Y)/N,'"',' cropbottom="',(ab-R-af)/ab,'"'," />","</g_vml_:group>");this.element_.insertAdjacentHTML("BeforeEnd",ac.join(""))};l.stroke=function(ah){var M=[];var N=false;var at=c(ah?this.fillStyle:this.strokeStyle);var ad=at.color;var an=at.alpha*this.globalAlpha;var J=10;var P=10;M.push("<g_vml_:shape",' filled="',!!ah,'"',' style="position:absolute;width:',J,"px;height:",P,'px;"',' coordorigin="0 0" coordsize="',a*J," ",a*P,'"',' stroked="',!ah,'"',' path="');var O=false;var ar={x:null,y:null};var Z={x:null,y:null};for(var am=0;am<this.currentPath_.length;am++){var al=this.currentPath_[am];var aq;switch(al.type){case"moveTo":aq=al;M.push(" m ",w(al.x),",",w(al.y));break;case"lineTo":M.push(" l ",w(al.x),",",w(al.y));break;case"close":M.push(" x ");al=null;break;case"bezierCurveTo":M.push(" c ",w(al.cp1x),",",w(al.cp1y),",",w(al.cp2x),",",w(al.cp2y),",",w(al.x),",",w(al.y));break;case"at":case"wa":M.push(" ",al.type," ",w(al.x-this.arcScaleX_*al.radius),",",w(al.y-this.arcScaleY_*al.radius)," ",w(al.x+this.arcScaleX_*al.radius),",",w(al.y+this.arcScaleY_*al.radius)," ",w(al.xStart),",",w(al.yStart)," ",w(al.xEnd),",",w(al.yEnd));break}if(al){if(ar.x==null||al.x<ar.x){ar.x=al.x}if(Z.x==null||al.x>Z.x){Z.x=al.x}if(ar.y==null||al.y<ar.y){ar.y=al.y}if(Z.y==null||al.y>Z.y){Z.y=al.y}}}M.push(' ">');if(!ah){var Y=this.lineScale_*this.lineWidth;if(Y<1){an*=Y}M.push("<g_vml_:stroke",' opacity="',an,'"',' joinstyle="',this.lineJoin,'"',' miterlimit="',this.miterLimit,'"',' endcap="',t(this.lineCap),'"',' weight="',Y,'px"',' color="',ad,'" />')}else{if(typeof this.fillStyle=="object"){var Q=this.fillStyle;var V=0;var ak={x:0,y:0};var ae=0;var T=1;if(Q.type_=="gradient"){var S=Q.x0_/this.arcScaleX_;var m=Q.y0_/this.arcScaleY_;var R=Q.x1_/this.arcScaleX_;var au=Q.y1_/this.arcScaleY_;var ap=this.getCoords_(S,m);var ao=this.getCoords_(R,au);var L=ao.x-ap.x;var K=ao.y-ap.y;V=Math.atan2(L,K)*180/Math.PI;if(V<0){V+=360}if(V<0.000001){V=0}}else{var ap=this.getCoords_(Q.x0_,Q.y0_);var j=Z.x-ar.x;var I=Z.y-ar.y;ak={x:(ap.x-ar.x)/j,y:(ap.y-ar.y)/I};j/=this.arcScaleX_*a;I/=this.arcScaleY_*a;var aj=v.max(j,I);ae=2*Q.r0_/aj;T=2*Q.r1_/aj-ae}var ac=Q.colors_;ac.sort(function(av,W){return av.offset-W.offset});var X=ac.length;var ab=ac[0].color;var aa=ac[X-1].color;var ag=ac[0].alpha*this.globalAlpha;var af=ac[X-1].alpha*this.globalAlpha;var ai=[];for(var am=0;am<X;am++){var U=ac[am];ai.push(U.offset*T+ae+" "+U.color)}M.push('<g_vml_:fill type="',Q.type_,'"',' method="none" focus="100%"',' color="',ab,'"',' color2="',aa,'"',' colors="',ai.join(","),'"',' opacity="',af,'"',' g_o_:opacity2="',ag,'"',' angle="',V,'"',' focusposition="',ak.x,",",ak.y,'" />')}else{M.push('<g_vml_:fill color="',ad,'" opacity="',an,'" />')}}M.push("</g_vml_:shape>");this.element_.insertAdjacentHTML("beforeEnd",M.join(""))};l.fill=function(){this.stroke(true)};l.closePath=function(){this.currentPath_.push({type:"close"})};l.getCoords_=function(J,I){var j=this.m_;return{x:a*(J*j[0][0]+I*j[1][0]+j[2][0])-o,y:a*(J*j[0][1]+I*j[1][1]+j[2][1])-o}};l.save=function(){var j={};z(this,j);this.aStack_.push(j);this.mStack_.push(this.m_);this.m_=d(r(),this.m_)};l.restore=function(){z(this.aStack_.pop(),this);this.m_=this.mStack_.pop()};function g(I){for(var K=0;K<3;K++){for(var J=0;J<2;J++){if(!isFinite(I[K][J])||isNaN(I[K][J])){return false}}}return true}function D(I,j,J){if(!g(j)){return}I.m_=j;if(J){var K=j[0][0]*j[1][1]-j[0][1]*j[1][0];I.lineScale_=F(n(K))}}l.translate=function(I,m){var j=[[1,0,0],[0,1,0],[I,m,1]];D(this,d(j,this.m_),false)};l.rotate=function(m){var J=G(m);var I=s(m);var j=[[J,I,0],[-I,J,0],[0,0,1]];D(this,d(j,this.m_),false)};l.scale=function(I,m){this.arcScaleX_*=I;this.arcScaleY_*=m;var j=[[I,0,0],[0,m,0],[0,0,1]];D(this,d(j,this.m_),true)};l.transform=function(K,J,M,L,m,j){var I=[[K,J,0],[M,L,0],[m,j,1]];D(this,d(I,this.m_),true)};l.setTransform=function(L,K,N,M,J,I){var j=[[L,K,0],[N,M,0],[J,I,1]];D(this,j,true)};l.clip=function(){};l.arcTo=function(){};l.createPattern=function(){return new f};function C(j){this.type_=j;this.x0_=0;this.y0_=0;this.r0_=0;this.x1_=0;this.y1_=0;this.r1_=0;this.colors_=[]}C.prototype.addColorStop=function(m,j){j=c(j);this.colors_.push({offset:m,color:j.color,alpha:j.alpha})};function f(){}G_vmlCanvasManager=k;CanvasRenderingContext2D=q;CanvasGradient=C;CanvasPattern=f})()};